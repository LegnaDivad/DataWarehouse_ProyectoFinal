<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados de Entrenamiento</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #22d3ee;
      --accent-2: #a855f7;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2937;
      --winner: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.08), transparent 30%),
                  radial-gradient(circle at 80% 10%, rgba(168,85,247,0.08), transparent 32%),
                  var(--bg);
      color: var(--text);
      font-family: "Manrope", system-ui, -apple-system, sans-serif;
      padding: 24px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
    }
    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(34,211,238,0.12);
      color: var(--accent);
      font-weight: 700;
      letter-spacing: 0.4px;
      font-size: 12px;
      text-transform: uppercase;
    }
    h1 { margin: 0; font-size: 24px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.28);
    }
    .input-area {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr 140px 140px;
      align-items: start;
    }
    textarea {
      width: 100%;
      height: 180px;
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      font-family: "Manrope", monospace;
      resize: vertical;
    }
    button {
      padding: 12px 14px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      color: #0b1220;
      transition: transform 0.08s ease, box-shadow 0.12s ease;
    }
    button.primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 18px rgba(34,211,238,0.3);
      color: #0b1220;
    }
    button.secondary {
      background: #1f2937;
      color: var(--text);
      border: 1px solid var(--border);
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .winner-title { font-size: 20px; margin: 12px 0 4px; color: var(--winner); }
    .muted { color: var(--muted); margin: 0 0 10px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow: hidden;
      border-radius: 12px;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border);
    }
    th { background: #161e31; }
    tr.winner-row { background: rgba(34,197,94,0.08); }
    .plots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
      margin-top: 16px;
    }
    .plot-card {
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
    }
    .plot-card img {
      width: 100%;
      border-radius: 8px;
    }
    .error { color: #f87171; margin: 6px 0 0; min-height: 18px; }
    @media (max-width: 820px) {
      .input-area { grid-template-columns: 1fr; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="badge">Visualizador ML</div>
      <h1>Resultados de entrenamiento</h1>
      <p class="muted">Pega el JSON de <code>/api/v1/training/run</code> y visualiza métricas y gráficas.</p>
    </div>
  </header>

  <div class="card">
    <div class="input-area">
      <textarea id="input-json" placeholder='{"training_run_id": "...", "models": {...}}'></textarea>
      <button id="btn-show" class="primary">Mostrar resultados</button>
      <button id="btn-sample" class="secondary">Cargar ejemplo</button>
    </div>
    <div id="error" class="error"></div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="winner-title" id="winner-title">Modelo ganador: -</div>
    <p class="muted" id="explanation"></p>

    <table id="metrics-table" style="display:none;">
      <thead>
        <tr><th>Modelo</th><th>MAE</th><th>MSE</th><th>RMSE</th><th>R²</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="plots" id="plots"></div>
  </div>

  <script>
    const btn = document.getElementById('btn-show');
    const btnSample = document.getElementById('btn-sample');
    const input = document.getElementById('input-json');
    const winnerTitle = document.getElementById('winner-title');
    const explanationEl = document.getElementById('explanation');
    const table = document.getElementById('metrics-table');
    const tbody = table.querySelector('tbody');
    const plotsContainer = document.getElementById('plots');
    const errorEl = document.getElementById('error');

    btn.addEventListener('click', () => {
      errorEl.textContent = '';
      let data;
      try {
        data = JSON.parse(input.value);
      } catch (e) {
        errorEl.textContent = 'JSON invalido. Verifica la sintaxis.';
        return;
      }
      render(data);
    });

    btnSample.addEventListener('click', () => {
      const sample = {
        "training_run_id": "demo",
        "metric_primary": "rmse",
        "best_model": {"name": "gbr", "metrics": {"mae": 0.8, "mse": 1.0, "rmse": 1.0, "r2": 0.92}},
        "models": {
          "linear": {"metrics": {"mae": 1.4, "mse": 3.0, "rmse": 1.732, "r2": 0.75}, "feature_cols": ["f1","f2"]},
          "rf": {"metrics": {"mae": 1.0, "mse": 1.8, "rmse": 1.342, "r2": 0.86}, "feature_cols": ["f1","f2"]},
          "gbr": {"metrics": {"mae": 0.8, "mse": 1.0, "rmse": 1.0, "r2": 0.92}, "feature_cols": ["f1","f2"]}
        },
        "plots": [
          {"path": "https://dummyimage.com/600x400/22d3ee/0b1220&text=RMSE", "title": "RMSE", "description": "Comparacion de RMSE"},
          {"path": "https://dummyimage.com/600x400/a855f7/0b1220&text=Real+vs+Pred", "title": "Real vs Pred", "description": "Dispersión del ganador"}
        ],
        "explanation": "Seleccionado gbr por menor RMSE."
      };
      input.value = JSON.stringify(sample, null, 2);
      render(sample);
    });

    function render(data) {
      if (!data.best_model || !data.best_model.name) {
        errorEl.textContent = "Falta el campo best_model.name en la respuesta.";
        return;
      }
      winnerTitle.textContent = `Modelo ganador: ${data.best_model.name}`;
      explanationEl.textContent = data.explanation || '';
      tbody.innerHTML = '';
      const models = data.models || {};
      Object.keys(models).forEach(name => {
        const m = models[name].metrics;
        const tr = document.createElement('tr');
        if (name === data.best_model.name) tr.classList.add('winner-row');
        tr.innerHTML = `
          <td>${name}</td>
          <td>${num(m.mae)}</td>
          <td>${num(m.mse)}</td>
          <td>${num(m.rmse)}</td>
          <td>${num(m.r2)}</td>
        `;
        tbody.appendChild(tr);
      });
      table.style.display = Object.keys(models).length ? 'table' : 'none';

      plotsContainer.innerHTML = '';
      (data.plots || []).forEach(p => {
        const card = document.createElement('div');
        card.className = 'plot-card';
        card.innerHTML = `
          <h4>${p.title}</h4>
          <img src="${p.path}" alt="${p.title}" />
          <p class="muted">${p.description}</p>
        `;
        plotsContainer.appendChild(card);
      });
    }

    function num(val) {
      return typeof val === "number" ? val.toFixed(4) : "-";
    }
  </script>
</body>
</html>
